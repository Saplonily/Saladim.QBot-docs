# UniNode

> 截止目前正在定义UniNode规范, 暂未在实际中实现
> 一经实现则此规范不再会修改

## 概念

介于不同的qq协议实现对消息段的处理各为不同, 比如 go-cqhttp 使用 cq 码, mirai-http 使用 mirai 码, 同时 Konata.Core 由于是c#原生实现可以直接提供消息链同时也提供了 kq 码. 虽然 SaladimQBot 在与协议实现交互时会将消息链自动转换为具体协议实现格式, 但是通常在内部构建消息链是一件麻烦的事, 所以为了方便以及兼容字符串处理方法等, 在此框架里我们提出了`UniNode`的概念.

## 解析

一般地, `UniNode`格式像这样:
```
<at:2748166392>
<reply:-321483>
<music,type=custom,url=http://baidu.com,audio=http://baidu.com/1.mp3,title=音乐标题>
<image:http://baidu.com/1.jpg>
<image,img=http://baidu.com/1.jpg>
```
自然地, 我们需要转义, 以下是目前的转义序列:
|  原符号  | 转义结果 |
| :------: | :------: |
| `换行符` |    \n    |
|  `空格`  |    \s    |
|    ,     |    \c    |
|    <     |    \l    |
|    >     |    \r    |

这里明显`UniNode`分为两种:
- 带主参UniNode
- 不带主参UniNode

`UniNode`大部分情况下都会拥有一个"主参", 比如`at节点`有`qq`这个主参, 当节点有主参时我们直接在节点类型名称后跟入`:`以及主参内容即可, 当有其他参数时只需加入逗号然后使用格式为`参数=值`的键值对的形式. 当节点没有主参时, 此时需跟入`,`而不是`:`. 当节点没有参数需要时, 无需跟入任何字符, 应该直接使用`>`关闭UniNode. 当参数键值对出现键名冲突时, 默认使用最后一次声明的键值对做值, 比如`<test,a=1,a=2>` UniNode中a的值会为2. 主参是参数的子对象, 也就是主参也能使用键值对的形式赋值, 比如这里的`<at:2748166392>`同样可以写成`<at,qq=2748166392>`, 同样的主参会被后面的键值对所覆盖. 当一个节点没有定义主参时主参会被**忽略**, 实现中可能会警告使用者解析失败.